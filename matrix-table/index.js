let datas = [
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10686,
        "Framework": 10103,
        "Competence": 13,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10682,
        "Framework": 10103,
        "Competence": 13,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:52.233",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "add1",
        "CompetenceName": "add1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10690,
        "Framework": 10103,
        "Competence": 13,
        "Position": 53,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10684,
        "Framework": 10103,
        "Competence": 3,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "KSTV",
        "PositionName": "Kế toán trưởng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "AC",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 8,
        "Code": 10693,
        "Framework": 10103,
        "Competence": 3,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 3,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BD",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 2,
        "Code": 10680,
        "Framework": 10103,
        "Competence": 3,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:46.593",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test1",
        "CompetenceName": "năng lực 1",
        "CategoryName": "Cốt lõi",
        "DepartmentID": "BOM",
        "CategoryID": "CL",
        "Category": 3,
        "Department": 1,
        "Code": 10688,
        "Framework": 10103,
        "Competence": 3,
        "Position": 53,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 4,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "AC",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 8,
        "Code": 10685,
        "Framework": 10103,
        "Competence": 5,
        "Position": 40,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BD",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 2,
        "Code": 10681,
        "Framework": 10103,
        "Competence": 5,
        "Position": 1,
        "CompetenceLevel": 3,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:48.53",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "Mô tả 1test",
        "CompetenceName": "Mô tả 1test",
        "CategoryName": "Năng lực bổ trợ",
        "DepartmentID": "BOM",
        "CategoryID": "BT",
        "Category": 4,
        "Department": 1,
        "Code": 10689,
        "Framework": 10103,
        "Competence": 5,
        "Position": 53,
        "CompetenceLevel": 2,
        "CompetenceLevelMax": 5,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "ACAD",
        "PositionName": "Admin cửa hàng",
        "DepartmentName": "Kế toán",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "AC",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 8,
        "Code": 10687,
        "Framework": 10103,
        "Competence": 8,
        "Position": 40,
        "CompetenceLevel": 1,
        "CompetenceLevelMax": 1,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:03.67",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "BDGD",
        "PositionName": "Giám đốc",
        "DepartmentName": "Ban Giám đốc",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BD",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 2,
        "Code": 10683,
        "Framework": 10103,
        "Competence": 8,
        "Position": 1,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:57:55.42",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    },
    {
        "PositionID": "LGWE",
        "PositionName": "Nhân viên kho",
        "DepartmentName": "Hội đồng thành viên",
        "CompetenceID": "test3",
        "CompetenceName": "năng lực 3",
        "CategoryName": "Năng lực marketing",
        "DepartmentID": "BOM",
        "CategoryID": "MA",
        "Category": 5,
        "Department": 1,
        "Code": 10691,
        "Framework": 10103,
        "Competence": 8,
        "Position": 53,
        "CompetenceLevel": null,
        "CompetenceLevelMax": null,
        "CreateBy": "Nguyễn Văn Hachi",
        "CreateTime": "2024-03-29T16:58:06.39",
        "LastModifiedBy": null,
        "LastModifiedTime": null
    }
]
let mapCompetence = new Map();
let mapPosition = new Map();

const htmlHeaderTop = `<th class="vertical-cell border-none"></th>
<th class="table-label"></th>
<th></th>`
const htmlHeaderBottom = `<th class="vertical-cell border-none"></th>
<th>
    <div class="table-label">
        <div class="label-top">Năng lực</div>
        <div class="border-label"></div>
        <div class="label-bottom">Vị trí</div>
    </div>
</th>
<th class="add-action">
    <i class="fa-solid fa-circle-plus"></i>
    <span style="display: inline-block;">Thêm năng lực</span>
</th>`
const htmlTbody = ` <tr>
<td class="vertical-cell border-none"></td>
<td class="add-action">
    <i class="fa-solid fa-circle-plus"></i>
    <span style="display: inline-block;">Thêm chức danh</span>
</td>
<td></td>
</tr>`

const loadData = () => {
    mapCompetence.clear();
    mapPosition.clear();
    datas.forEach(data => {
        if (mapCompetence.has(data["CategoryName"])) {
            let arrTemp = mapCompetence.get(data["CategoryName"])
            if (arrTemp.findIndex(c => c == data["CompetenceName"]) == -1) {
                arrTemp.push(data["CompetenceName"])
            }
            mapCompetence.set(data["CategoryName"], arrTemp)
        } else {
            let arrTemp = []
            arrTemp.push(data["CompetenceName"])
            mapCompetence.set(data["CategoryName"], arrTemp)
        }

        if (mapPosition.has(data["DepartmentName"])) {
            let arrTemp = mapPosition.get(data["DepartmentName"])
            if (arrTemp.findIndex(c => c == data["PositionName"]) == -1) {
                arrTemp.push(data["PositionName"])
            }
            mapPosition.set(data["DepartmentName"], arrTemp)
        } else {
            let arrTemp = []
            arrTemp.push(data["PositionName"])
            mapPosition.set(data["DepartmentName"], arrTemp)
        }
    })
}

const renderCompetenceHeader = () => {
    let htmlCategory = ``
    let htmlCompetence = ``
    mapCompetence.forEach((value, key) => {
        let competenceArr = value
        let colspan = competenceArr.length
        htmlCategory += ` <th class="category-name" colspan="${colspan}">${key}</th>`
        competenceArr.forEach(competence => {
            let htmlTemp = ``
            if (competence == competenceArr[0]) {
                htmlTemp = `<th class="competence-wrap" style="border-left: 1px solid #008000;">`
            }
            if (competence == competenceArr[colspan - 1]) {
                htmlTemp = `<th class="competence-wrap" style="border-right: 1px solid #008000;">`
            }
            if (competence == competenceArr[0] && competence == competenceArr[colspan - 1]) {
                htmlTemp = `<th class="competence-wrap" style="border-right: 1px solid #008000;border-left: 1px solid #008000;">`
            }
            htmlCompetence += htmlTemp + `            
            <div class="competence-item">
            <div class="competence-item--top">${competence}</div>
            <div class="competence-item--bottom"><span>Min</span><span>Max</span></div>
        </div></th>
        `
        })
    })
    const headerTop = document.querySelector(".header-top")
    const headrBottom = document.querySelector(".header-bottom")
    headerTop.innerHTML = htmlHeaderTop + htmlCategory
    headrBottom.innerHTML = htmlHeaderBottom + htmlCompetence
}
const renderPositionSidebar = () => {
    let htmlPosition = ``
    mapPosition.forEach((value, key) => {
        let positionArr = value
        let rowspan = positionArr.length + 1
        let htmlTemp = ``
        htmlTemp += `
        <tr class="department">
                    <th class="vertical-cell" rowspan="${rowspan}">${key}</th>
                </tr>
        `
        positionArr.forEach(p => {
            htmlTemp += `<tr data-position-name = "${p}" class="position-name" >
            <td ><div><span class="position-id"></span><span class="border-position"></span><span>${p}</span></div></td>
            <td></td>
            </tr>
        `
        })
        htmlPosition += htmlTemp
    })
    const tbody = document.querySelector(".matrix-table tbody")
    tbody.innerHTML = htmlTbody + htmlPosition
}
const renderDataTable = () => {
    loadData()
    renderPositionSidebar()
    renderCompetenceHeader()
    mapCompetence.forEach((value, key) => {
        let dataFilter = datas.filter(data => data["CategoryName"] == key)
        let trPosition = document.querySelectorAll(".position-name")
        if (dataFilter) {
            dataFilter.forEach(data => {
                trPosition.forEach(tr => {
                    if (tr.dataset.positionName == data["PositionName"]) {
                        const tdPositionId = tr.querySelector(".position-id")
                        tdPositionId.innerHTML = `${data["PositionID"]}`
                        tr.innerHTML += `<td class="data" data-code="${data["Code"]}"><div><input type="number" class="cell min-value" value="${data["CompetenceLevel"]}" onblur=(updateMinMax(${data["Code"]}))>
                        <input type="number" class="cell max-value" value="${data["CompetenceLevelMax"]}" onblur=(updateMinMax(${data["Code"]}))></div>
                        </td>`
                    }
                })
            })
        }
    })
}
renderDataTable()
const updateMinMax = (code) => {
    //take data to update
    code = Number(code)
    let updateData = {}
    let min, max = 0;
    let dataTd = document.querySelectorAll(".data")
    dataTd.forEach(td => {
        if (Number(td.dataset.code) == code) {
            min = Number(td.querySelector(".min-value").value)
            max = Number(td.querySelector(".max-value").value)
        }
    })
    updateData = {
        code,
        min,
        max
    }
    //update data
    if (!!updateData) {
        datas.map(data => {
            if (Number(data["Code"]) == Number(updateData["code"])) {
                if (Number(data["CompetenceLevel"]) != Number(updateData["min"]) || Number(data["CompetenceLevelMax"]) != Number(updateData["max"])) {
                    let isUpdate = false;
                    let oldMin = data["CompetenceLevel"]
                    let oldMax = data["CompetenceLevelMax"]
                    data["CompetenceLevel"] = Number(updateData["min"]) > 0 && ((Number(updateData["max"]) > 0 && Number(updateData["max"]) >= Number(updateData["min"])) || (Number(updateData["max"]) <= 0)) ? Number(updateData["min"]) : data["CompetenceLevel"]
                    data["CompetenceLevelMax"] = Number(updateData["max"]) > 0 && Number(updateData["max"]) >= Number(updateData["min"]) ? Number(updateData["max"]) : data["CompetenceLevelMax"]
                    if (oldMin !== data["CompetenceLevel"] || oldMax !== data["CompetenceLevelMax"]) {
                        isUpdate = true
                    }
                    if (isUpdate) {
                        updateData = data
                        showToast("Cập nhật khung năng lực thành công\n\n" + `Tên chức danh: ${updateData["PositionName"]}, Tên năng lực: ${updateData["CompetenceName"]}`,"toasts-success");
                    }

                }
            }
        })
    }
    renderDataTable()
}




function showToast(message, isSuccess,callback) {
    var toastClass = isSuccess ? 'toasts-success' : 'toasts-fail';
    var toastElement = document.createElement('div');
    toastElement.classList.add('toasts', toastClass);
    toastElement.innerHTML = '<div><i class="fa-regular fa-circle-' + (isSuccess ? 'check' : 'xmark') + ' pe-2"></i>' +
      '<p class="toasts-text">' + message + '</p></div>';
  toastElement.classList.add("d-flex","justify-content-start","align-items-center")
    document.body.appendChild(toastElement);
  
    setTimeout(function () {
      toastElement.classList.add('show');
    }, 100);
  
    setTimeout(function () {
      toastElement.remove();
      if (typeof callback === 'function') {
        callback(); 
      }
    }, 3000);
  }